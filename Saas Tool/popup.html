<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CRMSYNC</title>
  <link rel="stylesheet" href="popup.css">
</head>
<body>
  <div class="popup-container">
    <!-- Header -->
    <div class="popup-header" style="justify-content: space-between;">
      <div style="display: flex; align-items: center; gap: 6px;">
        <button class="popup-contacts-btn" id="leftHeaderBtn" title="Settings" style="position: relative; left: auto; padding: 8px 10px;">
          <span style="font-size: 20px;">âš™ï¸</span>
        </button>
        <button class="popup-contacts-btn" id="signInBtn" title="Sign In" style="display: none; padding: 4px 10px; font-size: 11px; font-weight: 600; min-width: auto; position: relative; left: auto;">
          Sign In
        </button>
      </div>
      <div style="display: flex; flex-direction: column; align-items: center; gap: 4px; position: absolute; left: 50%; transform: translateX(-50%);">
        <img src="icons/header-logo.png" alt="CRMSYNC" class="popup-logo-center" onerror="this.src='icons/widget-logo.png'" />
        <span id="subscriptionTierBadge" class="tier-badge tier-free" style="font-size: 9px; padding: 2px 8px;">FREE</span>
      </div>
      <button class="popup-widget-btn" id="showWidgetBtn" title="Show Widget on Gmail">
        ğŸ“Œ
      </button>
    </div>

    <!-- Tabs -->
    <div class="tabs-container">
      <button class="tab-btn active" data-tab="all-contacts">
        <span>Contacts</span>
      </button>
      <button class="tab-btn" data-tab="integrations">
        <span>ğŸ”Œ CRM</span>
      </button>
    </div>

    <!-- All Contacts Tab -->
    <div class="tab-content active" id="all-contacts-tab">
      <!-- Limit Warning Banner -->
      <div id="limitWarningBanner" style="display: none; background: linear-gradient(135deg, #f59e0b 0%, #ef4444 100%); color: white; padding: 12px 16px; border-radius: 8px; margin-bottom: 16px; text-align: center; font-size: 13px; font-weight: 500;">
        <div style="margin-bottom: 8px;">âš ï¸ <span id="limitWarningText">You're at your contact limit!</span></div>
        <button id="upgradeLimitBtn" style="background: white; color: #ef4444; border: none; padding: 6px 16px; border-radius: 6px; font-size: 12px; font-weight: 600; cursor: pointer;">
          âœ¨ Upgrade to Pro
        </button>
      </div>
      
      <!-- Stats Row -->
      <div class="quick-stats">
        <div class="stat-mini">
          <span class="stat-mini-value" id="contactLimitInfo">0</span>
          <span class="stat-mini-label">Total</span>
        </div>
        <div class="stat-mini">
          <span class="stat-mini-value" id="pendingCount">0</span>
          <span class="stat-mini-label">Pending</span>
        </div>
        <div class="stat-mini">
          <span class="stat-mini-value" id="newTodayMini">0</span>
          <span class="stat-mini-label">New ğŸ“…</span>
        </div>
      </div>

      <!-- Contact Limit Progress Bar -->
      <div id="contactLimitProgress" style="margin: 12px 0; padding: 12px; background: var(--surface); border-radius: 8px; border: 1px solid var(--border);">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
          <span style="font-size: 12px; font-weight: 600; color: var(--text);" id="limitProgressText">0 / 50 contacts</span>
          <span style="font-size: 11px; color: var(--text-secondary);" id="limitProgressPercent">0%</span>
        </div>
        <div style="width: 100%; height: 8px; background: var(--border); border-radius: 4px; overflow: hidden;">
          <div id="limitProgressBar" style="height: 100%; background: linear-gradient(90deg, #667eea 0%, #764ba2 100%); width: 0%; transition: width 0.3s ease, background 0.3s ease;"></div>
        </div>
        <div style="font-size: 10px; color: var(--text-secondary); margin-top: 4px; display: none;" id="limitProgressWarning">
          âš ï¸ <span id="limitProgressWarningText">Approaching limit</span>
        </div>
      </div>

      <!-- Search and Filters -->
      <div class="search-section">
        <input type="text" id="contactSearchInput" placeholder="Search contacts..." class="search-input">
        <div class="filter-row">
          <select id="sourceFilter" class="select-input" style="flex: 1;">
            <option value="">All Sources</option>
            <option value="gmail">ğŸ“§ Gmail</option>
            <option value="hubspot">H HubSpot</option>
            <option value="salesforce">S Salesforce</option>
          </select>
          <select id="statusFilter" class="select-input" style="flex: 1;">
            <option value="">All Status</option>
            <option value="approved">Approved</option>
            <option value="pending">Pending</option>
            <option value="archived">Archived</option>
          </select>
          <select id="sortBy" class="select-input" style="flex: 1;">
            <option value="lastContact">Recent</option>
            <option value="name">Name</option>
            <option value="company">Company</option>
          </select>
        </div>
      </div>

      <!-- Bulk Actions Toolbar - Compact & Subtle -->
      <div class="bulk-actions-toolbar" id="bulkActionsToolbar" style="padding: 6px 12px; background: var(--bg); border-radius: 6px; border: 1px solid var(--border); margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; font-size: 12px;">
        <div class="bulk-actions-left" style="display: flex; gap: 12px; align-items: center;">
          <span class="bulk-count" id="bulkSelectedCount" style="font-size: 12px; font-weight: 500; color: var(--text-secondary);">0 selected</span>
          <button class="btn-text" id="bulkSelectAll" style="font-size: 11px; padding: 3px 6px; color: var(--primary); background: none; border: none; cursor: pointer; font-weight: 500;">Select All</button>
          <button class="btn-text" id="bulkDeselectAll" style="font-size: 11px; padding: 3px 6px; color: var(--text-secondary); background: none; border: none; cursor: pointer; font-weight: 500;">Clear</button>
        </div>
        <div class="bulk-actions-right" style="display: flex; gap: 6px; align-items: center;">
          <button class="btn-icon-text btn-hubspot hidden" id="bulkPushHubSpot" title="Push selected to HubSpot" style="font-size: 11px; padding: 4px 8px; gap: 3px; min-width: auto; background: #FF7A59; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 500; display: flex; align-items: center;">
            <span style="font-size: 10px;">H</span>
          </button>
          <button class="btn-icon-text btn-salesforce hidden" id="bulkPushSalesforce" title="Push selected to Salesforce" style="font-size: 11px; padding: 4px 8px; gap: 3px; min-width: auto; background: #00A1E0; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 500; display: flex; align-items: center;">
            <span style="font-size: 10px;">S</span>
          </button>
          <button class="btn-icon-text" id="bulkExport" title="Export selected to CSV" style="font-size: 11px; padding: 4px 8px; background: var(--surface); color: var(--text); border: 1px solid var(--border); border-radius: 4px; cursor: pointer; font-weight: 500; display: flex; align-items: center; gap: 3px;">
            <span style="font-size: 10px;">ğŸ“¥</span>
            <span>Export</span>
          </button>
          <button class="btn-icon-text" id="bulkDelete" title="Delete selected contacts" style="font-size: 11px; padding: 4px 8px; background: transparent; color: #ef4444; border: 1px solid #ef4444; border-radius: 4px; cursor: pointer; font-weight: 500; display: flex; align-items: center; gap: 3px;">
            <span style="font-size: 10px;">ğŸ—‘ï¸</span>
          </button>
        </div>
      </div>

      <!-- Contacts Table -->
      <div class="contacts-table-wrapper">
        <table class="contacts-table">
          <thead>
            <tr>
              <th class="checkbox-col">
                <input type="checkbox" id="selectAllCheckbox" class="contact-checkbox" title="Select all">
              </th>
              <th>Contact</th>
              <th>Email</th>
              <th style="width: 50px; text-align: center;">Status</th>
              <th style="width: 50px; text-align: center;">Source</th>
              <th style="width: 60px; text-align: center;">Synced</th>
              <th style="width: 36px;"></th>
            </tr>
          </thead>
          <tbody id="allContactsTableBody">
            <!-- Contacts will be loaded here dynamically -->
          </tbody>
        </table>
      </div>

      <!-- Pagination -->
      <div class="pagination">
        <button class="btn-icon" id="prevPage" disabled>â†</button>
        <span class="page-info" id="pageInfo">Page 1</span>
        <button class="btn-icon" id="nextPage" disabled>â†’</button>
      </div>

      <!-- Actions -->
      <div class="actions-row">
        <button class="btn-secondary" id="exportAllContactsCSV">
          Export CSV
        </button>
        <button class="btn-secondary" id="refreshAllContacts">
          Refresh
        </button>
      </div>

      <!-- Additional Sections (Collapsible) -->
      <div style="margin-top: 16px; border-top: 1px solid var(--border); padding-top: 16px;">
        
        <!-- Today's Contacts -->
        <div class="section" id="todayContactsSection" style="display: none; margin-bottom: 12px;">
          <div class="section-header" style="cursor: pointer; padding: 8px 12px; background: var(--surface); border-radius: 8px; display: flex; justify-content: space-between; align-items: center;" id="todayContactsHeader">
            <h4 style="margin: 0; font-size: 13px; font-weight: 600;">ğŸ“… Today (<span id="todayContactsCount">0</span>) <span style="font-size: 11px; color: var(--text-secondary); font-weight: 400; margin-left: 4px;">Gmail only</span></h4>
            <span id="todayContactsToggle" style="font-size: 14px;">â–¶</span>
          </div>
          <div id="todayContactsContent" style="display: none; margin-top: 8px;">
            <div id="todayContactsList" class="contacts-list" style="max-height: 200px; overflow-y: auto;">
              <div class="empty-state">
                <p style="margin: 8px 0; color: var(--text-secondary); font-size: 12px;">No new Gmail contacts today</p>
                <p style="margin: 4px 0; font-size: 11px; color: var(--text-secondary);">ğŸ’¡ Send an email to automatically detect contacts</p>
              </div>
            </div>
            <button class="btn-secondary" id="exportTodayContacts" style="width: 100%; margin-top: 8px; font-size: 12px; padding: 6px;">
              ğŸ“¥ Export Today's Contacts
            </button>
          </div>
        </div>

        <!-- Pending Approvals -->
        <div class="section" id="pendingApprovalsSection" style="display: none; margin-bottom: 12px;">
          <div class="section-header" style="cursor: pointer; padding: 8px 12px; background: var(--surface); border-radius: 8px; display: flex; justify-content: space-between; align-items: center;" id="pendingApprovalsHeader">
            <h4 style="margin: 0; font-size: 13px; font-weight: 600;">â³ Pending (<span id="pendingApprovalsCount">0</span>)</h4>
            <span id="pendingApprovalsToggle" style="font-size: 14px;">â–¶</span>
          </div>
          <div id="pendingApprovalsContent" style="display: none; margin-top: 8px;">
            <div id="pendingList" class="contacts-list" style="max-height: 200px; overflow-y: auto;">
              <div class="empty-state">
                <p style="margin: 8px 0; color: var(--text-secondary); font-size: 12px;">No contacts pending approval</p>
                <p style="margin: 4px 0; font-size: 11px; color: var(--text-secondary);">âœ… All contacts are approved!</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Recent Contacts -->
        <div class="section" id="recentContactsSection" style="display: none; margin-bottom: 12px;">
          <div class="section-header" style="cursor: pointer; padding: 8px 12px; background: var(--surface); border-radius: 8px; display: flex; justify-content: space-between; align-items: center;" id="recentContactsHeader">
            <h4 style="margin: 0; font-size: 13px; font-weight: 600;">ğŸ•’ Recent (<span id="recentContactsCount">0</span>)</h4>
            <span id="recentContactsToggle" style="font-size: 14px;">â–¶</span>
          </div>
          <div id="recentContactsContent" style="display: none; margin-top: 8px;">
            <div id="recentContactsList" class="contacts-list" style="max-height: 200px; overflow-y: auto;">
              <div class="empty-state">
                <p style="margin: 8px 0; color: var(--text-secondary); font-size: 12px;">No recent contacts</p>
                <p style="margin: 4px 0; font-size: 11px; color: var(--text-secondary);">ğŸ’¬ Contacts you've emailed recently will appear here</p>
              </div>
            </div>
            <button class="btn-text" id="clearContacts" style="width: 100%; margin-top: 8px; font-size: 12px;">Clear All</button>
          </div>
        </div>

        <!-- Rejected Contacts -->
        <div class="section" id="rejectedContactsSection" style="display: none; margin-bottom: 12px;">
          <div class="section-header" style="cursor: pointer; padding: 8px 12px; background: var(--surface); border-radius: 8px; display: flex; justify-content: space-between; align-items: center;" id="rejectedContactsHeader">
            <h4 style="margin: 0; font-size: 13px; font-weight: 600;">ğŸš« Rejected (<span id="rejectedContactsCount">0</span>)</h4>
            <span id="rejectedContactsToggle" style="font-size: 14px;">â–¶</span>
          </div>
          <div id="rejectedContactsContent" style="display: none; margin-top: 8px;">
            <div id="rejectedContactsList" class="contacts-list" style="max-height: 200px; overflow-y: auto;">
              <div class="empty-state">
                <p style="margin: 8px 0; color: var(--text-secondary); font-size: 12px;">No rejected contacts</p>
              </div>
            </div>
            <button class="btn-text" id="clearRejected" style="width: 100%; margin-top: 8px; font-size: 12px;">Clear All</button>
          </div>
        </div>

      </div>
    </div>

    <!-- Settings Tab -->
    <div class="tab-content" id="settings-tab">
      <div class="settings-section">
        <!-- General Settings -->
        <div class="setting-group">
          <h3 class="group-title">General</h3>
          
          <div class="setting-item">
            <div class="setting-info">
              <label class="setting-label">Dark Mode</label>
              <span class="setting-description">Switch to night theme</span>
            </div>
            <label class="toggle-switch">
              <input type="checkbox" id="darkMode">
              <span class="toggle-slider"></span>
            </label>
          </div>

          <div class="setting-item">
            <div class="setting-info">
              <label class="setting-label">Sound Effects</label>
              <span class="setting-description">Play sounds on interactions</span>
            </div>
            <label class="toggle-switch">
              <input type="checkbox" id="soundEffects">
              <span class="toggle-slider"></span>
            </label>
          </div>

          <div class="setting-item">
            <div class="setting-info">
              <label class="setting-label">Enable Sidebar</label>
              <span class="setting-description">Show sidebar in Gmail</span>
            </div>
            <label class="toggle-switch">
              <input type="checkbox" id="sidebarEnabled" checked>
              <span class="toggle-slider"></span>
            </label>
          </div>
        </div>

        <!-- Contact Management -->
        <div class="setting-group">
          <h3 class="group-title">Contact Management</h3>
          
          <div class="setting-item">
            <div class="setting-info">
              <label class="setting-label">Auto-Approve Gmail Contacts</label>
              <span class="setting-description">Skip manual approval for Gmail contacts</span>
            </div>
            <label class="toggle-switch">
              <input type="checkbox" id="autoApprove">
              <span class="toggle-slider"></span>
            </label>
          </div>

          <div class="setting-item">
            <div class="setting-info">
              <label class="setting-label">Auto-Approve CRM Imports</label>
              <span class="setting-description">
                âœ… Auto-approve HubSpot/Salesforce imports<br>
                ğŸ’¡ Recommended: Keep enabled (CRM contacts are already vetted)
              </span>
            </div>
            <label class="toggle-switch">
              <input type="checkbox" id="autoApproveCRM" checked>
              <span class="toggle-slider"></span>
            </label>
          </div>
        </div>

        <!-- Advanced -->
        <div class="setting-group">
          <h3 class="group-title">Advanced</h3>
          
          <div class="setting-item-full">
            <label class="setting-label">Track Gmail Labels</label>
            <input type="text" id="gmailLabelsInput" placeholder="e.g., Outreach, Prospects" class="text-input">
            <span class="setting-description">Comma-separated. Leave empty to track all emails</span>
          </div>

          <!-- Account Settings -->
          <div class="setting-item-full" id="accountSettingsContainer" style="margin-top: 24px; display: none;">
            <label class="setting-label">ğŸ‘¤ Account Settings</label>
            <div style="background: var(--surface); padding: 16px; border-radius: 12px; margin-top: 8px; border: 1px solid var(--border);">
              <div style="display: flex; flex-direction: column; gap: 12px;">
                <div style="display: flex; align-items: center; gap: 12px;">
                  <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 16px;" id="accountAvatar">U</div>
                  <div style="flex: 1;">
                    <div style="display: flex; align-items: center; gap: 8px;">
                      <div style="font-weight: 600; font-size: 14px; color: var(--text);" id="accountName">Loading...</div>
                      <span id="accountTier" style="font-size: 10px; padding: 2px 8px; border-radius: 12px; font-weight: 600; text-transform: uppercase; background: #10b981; color: white;">FREE</span>
                    </div>
                    <div style="font-size: 12px; color: var(--text-secondary);" id="accountEmail">Loading...</div>
                  </div>
                </div>
                <button class="btn-secondary" id="upgradeBtn" style="width: 100%; padding: 10px; border-radius: 8px; font-weight: 500; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; margin-bottom: 8px; display: none;">
                  âœ¨ Upgrade to Pro
                </button>
                <button class="btn-secondary" id="settingsSignOutBtn" style="width: 100%; padding: 10px; border-radius: 8px; font-weight: 500; background: #ef4444; color: white; border: none;">
                  ğŸšª Sign Out
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Exclusions -->
        <div class="setting-group">
          <h3 class="group-title">ğŸš« Exclusions</h3>
          <p style="margin: 0 0 16px 0; font-size: 13px; color: var(--text-secondary); line-height: 1.5;">
            Block specific contacts from being tracked. Use commas to separate multiple entries.
          </p>
          
          <div class="setting-item-full">
            <label class="setting-label">ğŸ“§ Exclude Email Domains</label>
            <div class="tag-input-container">
              <div class="tags-display" id="excludeDomainsTags"></div>
              <input type="text" id="excludeDomainsInput" placeholder="Type domain and press Enter..." class="tag-text-input">
            </div>
            <span class="setting-description">
              âŒ Blocks: anyone@<strong>yourcompany.com</strong><br>
              ğŸ’¡ Type domain and press <strong>Enter</strong> to add
            </span>
          </div>

          <div class="setting-item-full">
            <label class="setting-label">ğŸ‘¤ Exclude Names</label>
            <div class="tag-input-container">
              <div class="tags-display" id="excludeNamesTags"></div>
              <input type="text" id="excludeNamesInput" placeholder="Type name and press Enter..." class="tag-text-input">
            </div>
            <span class="setting-description">
              <strong>Full Name:</strong> "John Smith" â†’ Blocks ONLY John Smith<br>
              ğŸ’¡ Type name and press <strong>Enter</strong> to add
            </span>
          </div>

          <div class="setting-item-full">
            <label class="setting-label">ğŸ“ Exclude Phone Numbers</label>
            <div class="tag-input-container">
              <div class="tags-display" id="excludePhonesTags"></div>
              <input type="text" id="excludePhonesInput" placeholder="Type phone and press Enter..." class="tag-text-input">
            </div>
            <span class="setting-description">
              âŒ Blocks these phone numbers<br>
              ğŸ’¡ Type number and press <strong>Enter</strong> to add
            </span>
          </div>
        </div>

        <!-- Inbox Sync (Pro Feature) -->
        <div class="setting-group" id="inboxSyncSection">
          <h3 class="group-title">ğŸ“¬ Inbox Sync</h3>
          <p style="margin: 0 0 16px 0; font-size: 13px; color: var(--text-secondary); line-height: 1.5;">
            Scan your entire Gmail inbox and sync thousands of contacts to your CRM automatically.
            <span class="pro-badge-inline">PRO</span>
          </p>
          
          <!-- Sync Status Card -->
          <div style="background: var(--surface); padding: 16px; border-radius: 12px; margin-bottom: 16px; border: 1px solid var(--border);">
            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
              <div style="display: flex; align-items: center; gap: 8px;">
                <div style="width: 8px; height: 8px; border-radius: 50%; background: #10b981;" id="inboxSyncStatusIndicator"></div>
                <span style="font-size: 13px; font-weight: 600; color: var(--text);" id="inboxSyncStatusText">Ready to sync</span>
              </div>
              <button class="btn-secondary" id="viewSyncHistoryBtn" style="font-size: 11px; padding: 6px 12px;">
                ğŸ“Š History
              </button>
            </div>
            
            <div id="lastSyncInfo" style="font-size: 12px; color: var(--text-secondary); margin-bottom: 12px; display: none;">
              <strong>Last sync:</strong> <span id="lastSyncTime">Never</span><br>
              <strong>Results:</strong> <span id="lastSyncResults">-</span>
            </div>
            
            <div style="display: flex; gap: 8px;">
              <button class="btn-primary" id="startInboxSyncBtn" style="flex: 1; font-size: 13px; padding: 10px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; font-weight: 600;">
                ğŸš€ Start Inbox Sync
              </button>
              <button class="btn-secondary" id="inboxSyncSettingsBtn" style="padding: 10px 16px; font-size: 13px;">
                âš™ï¸
              </button>
            </div>
          </div>
          
          <!-- Sync Options (Hidden by default, shown when settings clicked) -->
          <div id="inboxSyncOptions" style="display: none; background: var(--surface); padding: 16px; border-radius: 12px; border: 1px solid var(--border);">
            <h4 style="font-size: 13px; font-weight: 600; margin: 0 0 12px 0; color: var(--text);">Sync Options</h4>
            
            <div class="setting-item-full" style="margin-bottom: 12px;">
              <label class="setting-label">Scan Range</label>
              <select id="inboxSyncDateRange" class="select-input">
                <option value="30d">Last 30 days</option>
                <option value="90d" selected>Last 90 days (recommended)</option>
                <option value="180d">Last 6 months</option>
                <option value="365d">Last year</option>
                <option value="all">Entire inbox</option>
              </select>
              <span class="setting-description">How far back to scan</span>
            </div>
            
            <div class="setting-item">
              <div class="setting-info">
                <label class="setting-label">Update Existing Contacts</label>
                <span class="setting-description">Refresh data for contacts already in CRM</span>
              </div>
              <label class="toggle-switch">
                <input type="checkbox" id="inboxSyncUpdateExisting" checked>
                <span class="toggle-slider"></span>
              </label>
            </div>
            
            <div class="setting-item">
              <div class="setting-info">
                <label class="setting-label">Create New Contacts</label>
                <span class="setting-description">Add contacts not yet in CRM</span>
              </div>
              <label class="toggle-switch">
                <input type="checkbox" id="inboxSyncCreateNew" checked>
                <span class="toggle-slider"></span>
              </label>
            </div>
            
            <button class="btn-secondary" id="saveInboxSyncOptions" style="width: 100%; margin-top: 12px; font-size: 12px; padding: 8px;">
              âœ… Save Options
            </button>
          </div>
          
          <!-- What Gets Synced Info -->
          <div style="background: linear-gradient(135deg, #f0f9ff 0%, #dbeafe 100%); padding: 12px; border-radius: 8px; margin-top: 12px; border: 1px solid #3b82f6;">
            <div style="font-size: 12px; color: #1e3a8a; line-height: 1.5;">
              <strong>âœ¨ What gets synced:</strong><br>
              â€¢ Contact names & emails<br>
              â€¢ Last contact date<br>
              â€¢ Updates existing contacts with latest info<br>
              â€¢ Smart duplicate detection
            </div>
          </div>
        </div>

        <!-- Data Management -->
        <div class="setting-group">
          <h3 class="group-title">Data</h3>
          
          <!-- Sample Data Controls -->
          <div id="sampleDataControls" style="margin-bottom: 16px; padding: 16px; background: linear-gradient(135deg, #f0f9ff 0%, #e0e7ff 100%); border-radius: 12px; border: 2px solid #667eea;">
            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
              <span style="font-size: 20px;">ğŸ“¦</span>
              <h4 style="font-size: 14px; font-weight: 600; color: #1e293b; margin: 0;">Sample Data</h4>
            </div>
            <p style="font-size: 12px; color: #64748b; margin-bottom: 12px; line-height: 1.4;">
              Load 5 sample contacts to explore features
            </p>
            <div style="display: flex; gap: 8px;">
              <button class="btn-secondary" id="loadSampleData" style="flex: 1; font-size: 12px; padding: 8px;">
                âœ¨ Load Samples
              </button>
              <button class="btn-text" id="clearSampleData" style="flex: 1; font-size: 12px; padding: 8px;">
                ğŸ—‘ï¸ Clear Samples
              </button>
            </div>
          </div>
          
          <!-- Widget Position Reset -->
          <div style="margin-bottom: 16px; padding: 16px; background: linear-gradient(135deg, #fce7f3 0%, #fbcfe8 100%); border-radius: 12px; border: 2px solid #ec4899;">
            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
              <span style="font-size: 20px;">ğŸ“</span>
              <h4 style="font-size: 14px; font-weight: 600; color: #1e293b; margin: 0;">Widget Position</h4>
            </div>
            <p style="font-size: 12px; color: #64748b; margin-bottom: 12px; line-height: 1.4;">
              Widget moved somewhere? Reset it to default position
            </p>
            <button class="btn-secondary" id="resetWidgetPosition" style="width: 100%; font-size: 12px; padding: 8px;">
              ğŸ”„ Reset Widget Position
            </button>
          </div>
          
          <!-- Feature Tour -->
          <div style="margin-bottom: 16px; padding: 16px; background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border-radius: 12px; border: 2px solid #f59e0b;">
            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
              <span style="font-size: 20px;">ğŸ¯</span>
              <h4 style="font-size: 14px; font-weight: 600; color: #1e293b; margin: 0;">Feature Tour</h4>
            </div>
            <p style="font-size: 12px; color: #64748b; margin-bottom: 12px; line-height: 1.4;">
              Take a guided tour of all features
            </p>
            <button class="btn-secondary" id="startFeatureTour" style="width: 100%; font-size: 12px; padding: 8px;">
              ğŸš€ Start Tour
            </button>
          </div>
          
          <button class="btn-danger" id="clearAllData">
            <span>ğŸ—‘ï¸</span>
            <span>Clear All Data</span>
          </button>
        </div>
      </div>
    </div>

    <!-- Integrations Tab -->
    <div class="tab-content" id="integrations-tab">
      <div class="tab-header">
        <h2>ğŸ”Œ CRM Platforms</h2>
        <p class="tab-subtitle">Manage connections and sync settings</p>
      </div>

      <!-- Connected Platforms Overview -->
      <div class="platforms-overview" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; margin-bottom: 20px;">
        <div class="platform-card" id="hubspot-overview-card" style="padding: 12px; background: var(--surface); border-radius: 8px; border: 1px solid var(--border);">
          <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
            <span style="font-size: 20px;">ğŸŸ </span>
            <span style="font-weight: 600; font-size: 13px;">HubSpot</span>
          </div>
          <div class="platform-status" id="hubspot-overview-status" style="font-size: 11px; color: var(--text-secondary);">
            Not connected
          </div>
          <div class="platform-count" id="hubspot-overview-count" style="font-size: 20px; font-weight: 700; color: var(--text); margin-top: 8px; display: none;">
            0
            <span style="font-size: 11px; font-weight: 400; color: var(--text-secondary);">contacts</span>
          </div>
        </div>
        
        <div class="platform-card" id="salesforce-overview-card" style="padding: 12px; background: var(--surface); border-radius: 8px; border: 1px solid var(--border);">
          <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
            <span style="font-size: 20px;">ğŸ”µ</span>
            <span style="font-weight: 600; font-size: 13px;">Salesforce</span>
          </div>
          <div class="platform-status" id="salesforce-overview-status" style="font-size: 11px; color: var(--text-secondary);">
            Not connected
          </div>
          <div class="platform-count" id="salesforce-overview-count" style="font-size: 20px; font-weight: 700; color: var(--text); margin-top: 8px; display: none;">
            0
            <span style="font-size: 11px; font-weight: 400; color: var(--text-secondary);">contacts</span>
          </div>
        </div>
      </div>

      <!-- Sync Rules & Settings -->
      <div class="sync-rules-section" style="background: linear-gradient(135deg, #f0f9ff 0%, #e0e7ff 100%); padding: 16px; border-radius: 12px; margin-bottom: 20px; border: 2px solid #667eea;">
        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
          <span style="font-size: 20px;">âš™ï¸</span>
          <h3 style="font-size: 14px; font-weight: 600; margin: 0;">Sync Rules</h3>
        </div>
        
        <div style="display: flex; flex-direction: column; gap: 12px;">
          <!-- Auto-Sync Toggle -->
          <div style="display: flex; align-items: center; justify-content: space-between; padding: 10px; background: white; border-radius: 8px;">
            <div style="flex: 1;">
              <div style="font-size: 12px; font-weight: 600; margin-bottom: 2px;">âš¡ Auto-Push New Contacts</div>
              <div style="font-size: 10px; color: var(--text-secondary);">Automatically push to CRM when detected</div>
            </div>
            <label class="toggle-switch" style="transform: scale(0.8);">
              <input type="checkbox" id="autoSyncEnabled">
              <span class="toggle-slider"></span>
            </label>
          </div>
          
          <!-- Auto-Approve Imports -->
          <div style="display: flex; align-items: center; justify-content: space-between; padding: 10px; background: white; border-radius: 8px;">
            <div style="flex: 1;">
              <div style="font-size: 12px; font-weight: 600; margin-bottom: 2px;">âœ… Auto-Approve CRM Imports</div>
              <div style="font-size: 10px; color: var(--text-secondary);">Skip approval for contacts from HubSpot/Salesforce</div>
            </div>
            <label class="toggle-switch" style="transform: scale(0.8);">
              <input type="checkbox" id="autoApproveCRMImports" checked>
              <span class="toggle-slider"></span>
            </label>
          </div>
        </div>
      </div>

      <!-- Sync Status Overview -->
      <div class="sync-status-section" style="margin-bottom: 20px;">
        <h3 style="font-size: 14px; font-weight: 600; margin-bottom: 12px; color: var(--text);">ğŸ“Š Sync Status Overview</h3>
        
        <!-- HubSpot Sync Status -->
        <div class="platform-sync-status" id="hubspot-sync-status-card" style="display: none; background: var(--surface); border-radius: 8px; border: 1px solid var(--border); padding: 14px; margin-bottom: 12px;">
          <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px;">
            <div style="display: flex; align-items: center; gap: 8px;">
              <span style="background: #ff7a59; color: white; font-size: 10px; width: 20px; height: 20px; border-radius: 4px; display: flex; align-items: center; justify-content: center; font-weight: 600;">H</span>
              <span style="font-weight: 600; font-size: 13px;">HubSpot</span>
            </div>
            <button class="btn-text" id="hubspot-view-details" style="font-size: 11px; color: var(--primary);">View Details</button>
          </div>
          <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; font-size: 11px;">
            <div style="text-align: center; padding: 8px; background: var(--bg); border-radius: 6px;">
              <div style="font-size: 16px; font-weight: 700; color: #22c55e;" id="hubspot-synced-count">0</div>
              <div style="color: var(--text-secondary); margin-top: 2px;">âœ“ Synced</div>
            </div>
            <div style="text-align: center; padding: 8px; background: var(--bg); border-radius: 6px;">
              <div style="font-size: 16px; font-weight: 700; color: #eab308;" id="hubspot-pending-count">0</div>
              <div style="color: var(--text-secondary); margin-top: 2px;">â³ Pending</div>
            </div>
            <div style="text-align: center; padding: 8px; background: var(--bg); border-radius: 6px;">
              <div style="font-size: 16px; font-weight: 700; color: #ef4444;" id="hubspot-not-synced-count">0</div>
              <div style="color: var(--text-secondary); margin-top: 2px;">âœ— Not Synced</div>
            </div>
          </div>
        </div>
        
        <!-- Salesforce Sync Status -->
        <div class="platform-sync-status" id="salesforce-sync-status-card" style="display: none; background: var(--surface); border-radius: 8px; border: 1px solid var(--border); padding: 14px;">
          <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px;">
            <div style="display: flex; align-items: center; gap: 8px;">
              <span style="background: #00a1e0; color: white; font-size: 10px; width: 20px; height: 20px; border-radius: 4px; display: flex; align-items: center; justify-content: center; font-weight: 600;">S</span>
              <span style="font-weight: 600; font-size: 13px;">Salesforce</span>
            </div>
            <button class="btn-text" id="salesforce-view-details" style="font-size: 11px; color: var(--primary);">View Details</button>
          </div>
          <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; font-size: 11px;">
            <div style="text-align: center; padding: 8px; background: var(--bg); border-radius: 6px;">
              <div style="font-size: 16px; font-weight: 700; color: #22c55e;" id="salesforce-synced-count">0</div>
              <div style="color: var(--text-secondary); margin-top: 2px;">âœ“ Synced</div>
            </div>
            <div style="text-align: center; padding: 8px; background: var(--bg); border-radius: 6px;">
              <div style="font-size: 16px; font-weight: 700; color: #eab308;" id="salesforce-pending-count">0</div>
              <div style="color: var(--text-secondary); margin-top: 2px;">â³ Pending</div>
            </div>
            <div style="text-align: center; padding: 8px; background: var(--bg); border-radius: 6px;">
              <div style="font-size: 16px; font-weight: 700; color: #ef4444;" id="salesforce-not-synced-count">0</div>
              <div style="color: var(--text-secondary); margin-top: 2px;">âœ— Not Synced</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Sync Status by Platform -->
      <div class="integration-card">
        <div class="integration-header">
          <div class="integration-logo-container">
            <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='45' fill='%23ff7a59'/%3E%3C/svg%3E" alt="HubSpot" class="integration-logo">
            <div class="integration-logo-text">H</div>
          </div>
          <div class="integration-info">
            <h3>HubSpot</h3>
            <p class="integration-status" id="hubspot-status">Not connected</p>
            <p class="integration-meta" id="hubspot-account" style="display: none; font-size: 12px; color: var(--text-secondary); margin-top: 2px;"></p>
          </div>
        </div>
        
        <!-- Sync Stats (shown when connected) -->
        <div class="integration-stats hidden" id="hubspot-stats">
          <div class="stat-item">
            <div class="stat-label">ğŸ“Š Synced Contacts</div>
            <div class="stat-value" id="hubspot-count">0</div>
          </div>
          <div class="stat-item">
            <div class="stat-label">ğŸ• Last Sync</div>
            <div class="stat-value" id="hubspot-last-sync">Never</div>
          </div>
          <div class="stat-item">
            <div class="stat-label">ğŸ“ˆ Status</div>
            <div class="stat-value" id="hubspot-sync-status">
              <span class="status-badge status-idle">Idle</span>
            </div>
          </div>
        </div>
        
        <!-- Progress Bar (shown during sync) -->
        <div class="sync-progress hidden" id="hubspot-progress">
          <div class="progress-bar">
            <div class="progress-fill" id="hubspot-progress-fill"></div>
          </div>
          <p class="progress-text" id="hubspot-progress-text">Syncing contacts...</p>
        </div>
        
        <div class="integration-actions">
          <button class="btn btn-primary" id="hubspot-connect-btn">
            <span>Connect HubSpot</span>
          </button>
          <button class="btn btn-secondary hidden" id="hubspot-sync-all-btn">
            <span>ğŸ”„ Sync All Contacts</span>
          </button>
          <button class="btn btn-danger hidden" id="hubspot-disconnect-btn">
            <span>Disconnect</span>
          </button>
        </div>
      </div>

      <!-- Salesforce Integration Card -->
      <div class="integration-card">
        <div class="integration-header">
          <div class="integration-logo-container">
            <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='45' fill='%2300a1e0'/%3E%3C/svg%3E" alt="Salesforce" class="integration-logo">
            <div class="integration-logo-text">S</div>
          </div>
          <div class="integration-info">
            <h3>Salesforce</h3>
            <p class="integration-status" id="salesforce-status">Not connected</p>
            <p class="integration-meta" id="salesforce-account" style="display: none; font-size: 12px; color: var(--text-secondary); margin-top: 2px;"></p>
          </div>
        </div>
        
        <!-- Sync Stats (shown when connected) -->
        <div class="integration-stats hidden" id="salesforce-stats">
          <div class="stat-item">
            <div class="stat-label">ğŸ“Š Synced Contacts</div>
            <div class="stat-value" id="salesforce-count">0</div>
          </div>
          <div class="stat-item">
            <div class="stat-label">ğŸ• Last Sync</div>
            <div class="stat-value" id="salesforce-last-sync">Never</div>
          </div>
          <div class="stat-item">
            <div class="stat-label">ğŸ“ˆ Status</div>
            <div class="stat-value" id="salesforce-sync-status">
              <span class="status-badge status-idle">Idle</span>
            </div>
          </div>
        </div>
        
        <!-- Progress Bar (shown during sync) -->
        <div class="sync-progress hidden" id="salesforce-progress">
          <div class="progress-bar">
            <div class="progress-fill" id="salesforce-progress-fill"></div>
          </div>
          <p class="progress-text" id="salesforce-progress-text">Syncing contacts...</p>
        </div>
        
        <div class="integration-actions">
          <button class="btn btn-primary" id="salesforce-connect-btn">
            <span>Connect Salesforce</span>
          </button>
          <button class="btn btn-secondary hidden" id="salesforce-sync-all-btn">
            <span>ğŸ”„ Sync All Contacts</span>
          </button>
          <button class="btn btn-danger hidden" id="salesforce-disconnect-btn">
            <span>Disconnect</span>
          </button>
        </div>
      </div>

      <!-- Sync History & Logs -->
      <div class="sync-history-section" id="syncHistorySection" style="margin-top: 24px;">
        <div class="history-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
          <h3 style="font-size: 16px; font-weight: 600; color: var(--text);">ğŸ“‹ Recent Sync Operations</h3>
          <button class="btn-text" id="clearHistoryBtn" style="font-size: 12px; color: var(--text-secondary);">Clear History</button>
        </div>
        
        <div class="history-filters" style="display: flex; gap: 8px; margin-bottom: 12px;">
          <select id="historyPlatformFilter" class="select-input" style="flex: 1;">
            <option value="">All Platforms</option>
            <option value="hubspot">HubSpot</option>
            <option value="salesforce">Salesforce</option>
          </select>
          <select id="historyResultFilter" class="select-input" style="flex: 1;">
            <option value="">All Results</option>
            <option value="success">Success</option>
            <option value="error">Error</option>
          </select>
        </div>
        
        <div class="sync-history-table-wrapper" style="max-height: 400px; overflow-y: auto; border: 1px solid var(--border); border-radius: 8px;">
          <table class="sync-history-table" style="width: 100%; border-collapse: collapse;">
            <thead style="position: sticky; top: 0; background: var(--surface); z-index: 1;">
              <tr>
                <th style="padding: 10px; text-align: left; font-size: 11px; font-weight: 600; text-transform: uppercase; color: var(--text-secondary); border-bottom: 1px solid var(--border);">Time</th>
                <th style="padding: 10px; text-align: left; font-size: 11px; font-weight: 600; text-transform: uppercase; color: var(--text-secondary); border-bottom: 1px solid var(--border);">Platform</th>
                <th style="padding: 10px; text-align: left; font-size: 11px; font-weight: 600; text-transform: uppercase; color: var(--text-secondary); border-bottom: 1px solid var(--border);">Contact</th>
                <th style="padding: 10px; text-align: left; font-size: 11px; font-weight: 600; text-transform: uppercase; color: var(--text-secondary); border-bottom: 1px solid var(--border);">Action</th>
                <th style="padding: 10px; text-align: left; font-size: 11px; font-weight: 600; text-transform: uppercase; color: var(--text-secondary); border-bottom: 1px solid var(--border);">Result</th>
              </tr>
            </thead>
            <tbody id="syncHistoryTableBody">
              <tr>
                <td colspan="5" style="padding: 40px; text-align: center; color: var(--text-secondary);">
                  <div style="font-size: 32px; margin-bottom: 8px;">ğŸ“­</div>
                  <div style="font-size: 14px;">No sync history yet</div>
                  <div style="font-size: 12px; margin-top: 4px;">Sync operations will appear here</div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
        
        <div class="history-stats" style="display: flex; justify-content: space-between; margin-top: 12px; padding: 12px; background: var(--surface); border-radius: 8px; font-size: 12px;">
          <span style="color: var(--text-secondary);">Total: <strong id="historyTotal" style="color: var(--text);">0</strong></span>
          <span style="color: var(--success);">Success: <strong id="historySuccess">0</strong></span>
          <span style="color: var(--error);">Failed: <strong id="historyFailed">0</strong></span>
        </div>
      </div>

      <!-- Info Box -->
      <div class="info-box">
        <h4>ğŸ’¡ How it works</h4>
        <ul>
          <li><strong>Connect:</strong> Authorize access to your CRM (secure OAuth)</li>
          <li><strong>Sync:</strong> Pull existing contacts to show "âœ“ In CRM" badges</li>
          <li><strong>Push:</strong> Add new contacts with one click</li>
          <li><strong>Auto-Sync:</strong> Enable to automatically push new contacts</li>
          <li><strong>Duplicate Detection:</strong> Smart checks prevent duplicates</li>
        </ul>
        <p class="info-note">
          ğŸ”’ Your credentials are never stored in the extension. All connections are secure and can be disconnected anytime.
        </p>
      </div>
    </div>
  </div>

  <!-- Data Merge Dialog -->
  <div id="dataMergeDialog" class="data-merge-overlay">
    <div style="background: white; padding: 32px; border-radius: 16px; max-width: 500px; width: 90%; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
      <div style="text-align: center; margin-bottom: 24px;">
        <div style="font-size: 48px; margin-bottom: 12px;">ğŸ”„</div>
        <h2 style="margin: 0 0 8px 0; font-size: 22px; color: #1e293b;">Welcome Back!</h2>
        <p style="margin: 0; color: #64748b; font-size: 14px; line-height: 1.5;">
          You have <strong id="localContactCount">0</strong> contacts saved locally. Would you like to keep them or use your synced data?
        </p>
      </div>
      
      <div style="display: flex; flex-direction: column; gap: 12px;">
        <button id="keepLocalDataBtn" class="data-merge-btn-primary" style="padding: 16px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 10px; font-weight: 600; font-size: 15px; cursor: pointer; transition: all 0.2s;">
          ğŸ“¦ Keep My Local Data
          <div style="font-size: 12px; font-weight: 400; opacity: 0.9; margin-top: 4px;">
            Merge local contacts with cloud data
          </div>
        </button>
        
        <button id="useSyncedDataBtn" class="data-merge-btn-secondary" style="padding: 16px; background: white; color: #475569; border: 2px solid #e2e8f0; border-radius: 10px; font-weight: 600; font-size: 15px; cursor: pointer; transition: all 0.2s;">
          â˜ï¸ Use Synced Data
          <div style="font-size: 12px; font-weight: 400; opacity: 0.8; margin-top: 4px;">
            Replace local data with cloud data
          </div>
        </button>
        
        <button id="cancelMergeBtn" class="data-merge-btn-cancel" style="padding: 12px; background: transparent; color: #94a3b8; border: none; font-size: 13px; cursor: pointer; transition: all 0.2s;">
          Decide Later
        </button>
      </div>
    </div>
  </div>
  
  <style>
    .data-merge-btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 16px rgba(102, 126, 234, 0.3);
    }
    .data-merge-btn-secondary:hover {
      background: #f8fafc;
      border-color: #cbd5e1;
    }
    .data-merge-btn-cancel:hover {
      color: #64748b;
    }
    
    /* Loading Overlay */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 99999;
      backdrop-filter: blur(4px);
    }
    
    .loading-overlay.hidden {
      display: none;
    }
    
    .loading-spinner-container {
      background: var(--surface, white);
      padding: 32px;
      border-radius: 12px;
      text-align: center;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
    }
    
    .loading-spinner {
      width: 48px;
      height: 48px;
      border: 4px solid var(--border, #e2e8f0);
      border-top-color: var(--primary, #667eea);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin: 0 auto 16px;
    }
    
    .loading-message {
      margin: 0;
      color: var(--text, #1e293b);
      font-size: 14px;
      font-weight: 500;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* Inline Loading */
    .inline-loading {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 24px;
      color: var(--text-secondary, #64748b);
      font-size: 13px;
    }
    
    .loading-spinner-small {
      width: 16px;
      height: 16px;
      border: 2px solid var(--border, #e2e8f0);
      border-top-color: var(--primary, #667eea);
      border-radius: 50%;
      animation: spin 0.6s linear infinite;
    }
    
    /* Button Loading */
    .button-spinner {
      display: inline-block;
      width: 14px;
      height: 14px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 0.6s linear infinite;
      vertical-align: middle;
      margin-right: 4px;
    }
  </style>

  <!-- Core Scripts -->
  <script src="config.js"></script>
  <script src="logger.js"></script>
  <script src="error-handler.js"></script>
  <script src="loading-manager.js"></script>
  <script src="auth.js"></script>
  <script src="sync.js"></script>
  <script src="integrations.js"></script>
  <script src="inboxSyncManager.js"></script>
  <script src="popup-inbox-sync.js"></script>
  
  <!-- UX Enhancement Scripts -->
  <script src="toast.js"></script>
  <script src="darkMode.js"></script>
  <script src="quickActions.js"></script>
  <script src="analytics.js"></script>
  
  <!-- Feature Scripts -->
  <script src="guest-mode-banner.js"></script>
  <script src="feature-tour.js"></script>
  <script src="popup-subscription.js"></script>
  <script src="popup.js"></script>
  <script src="popup-enhancements.js"></script>

</body>
</html>
